<!--
@license
Copyright (c) 2015 ubs121
-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">


<link rel="import" href="gpay-btn/gpay-btn.html">

<script src="../bower_components/d3/d3.min.js"></script>

<dom-module id="p-catalog">
  <style>
    :host {
      display: block;
    }

    aside {
      background: white;
      display: block;
      height: auto;
      width: 200px;
    }

    .item {
        display: block;
        float: left;
        height: 140px;
        width: 220px;
        margin: 15px;
        padding: 10px;
        background: white;
      }

      .categ {
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 12px;
        padding: 7px 20px;
        color: #999;
        margin-top: 5px;
      }

      .categ:hover, .categ.active {
        border-color: #709700;
        color: #709700;
      }

      .paper-font-body1 {
        text-transform: uppercase;
        padding: 5px 0;
        color: #444;
        text-decoration: none;
        line-height: 16px;
      }

      .paper-font-body1:hover {
        text-decoration: underline;
      }

      .item.p-catalog {
        height: 185px;
      }

      .attr {
        font-size: 11px;
        color: #999;
      }

      paper-icon-button.cart {
        background: #709700;
        border-radius: 20px;
        color: #FFF;
        bottom: 10px;
        right: 10px;
        position: absolute;
      }
  </style>

  <template>
     <iron-ajax id="xhrProduct"
       url="http://localhost:3000/s/find"
       method="post"
       handle-as="json"
       on-response="handleItems"></iron-ajax>

     <iron-ajax id="xhrTags"
       url="http://localhost:3000/s/find"
       method="post"
       handle-as="json"
       on-response="handleTags"></iron-ajax>

     <!-- TODO: https://www.apm.mn/ зүүн талын toolbar харах -->
     <template is="dom-repeat" items="[[menu]]">
       <paper-button class="categ" href="#" on-tap="filter"
            style="background:[[item.color]]">
        [[item.name]]
       </paper-button>
     </template>
      <br/>


    <div class="layout horizontal" style="margin-top: 15px;">


       <!-- TODO: Эрэмбэлэх: үнээр, нийлүүлэгчээр -->
       <!-- TODO: Сагсанд бараа нэмэх -->
       <!-- TODO: Төлбөр хийх -->

      <!-- барааны жагсаалт-->
      <div class="flex">
      <template is="dom-repeat" items="[[items]]" >
        <paper-material class="item layout vertical" elevation="1">
          <img src="{{item.image}}" style="height: 102px">
          <a href="/p/{{item.productID}}" class="paper-font-body1">{{item.name}}</a>
          <div class="attr">{{item.price}}₮</div>            <!-- <paper-icon-button icon="refresh"></paper-icon-button> -->
          <a on-click="_toCart"><paper-icon-button icon="add-shopping-cart" title="Сагсанд нэмэх" class="cart"></paper-icon-button></a>
        </paper-material>
      </template>
      </div>


       <aside>
        <input placeholder="filter"/>
        <template is="dom-repeat" items="[[tags]]">
           <button class="tags" href="#" on-tap="filter"
                style="background:[[item.color]]">
            [[item._id]]
           </button>
         </template>
       </aside>


    </div>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'p-catalog',
        properties: {
          items: {
            type: Array,
            notify: true,
          },

          tags: {
              type: Array
          }
        },

        ready: function() {

        // TODO: каталогит icon нэмэх. http://www.flaticon.com/packs/shopping
          this.menu = [
            {name: 'хувцас', 'count': '11', 'color':'#3182BD',  'rank': 4.5},
            {name: 'гоёл', 'count': '11', 'color':'#3182BD',  'rank': 4.5},
            {name: 'гэр ахуй', 'count': 12, 'color': '#E7560D'},
            {name: 'хүнс', 'count': 12, 'color': '#E7560D'},
            {name: 'компютер', 'color': '#FDAE6B', '_tags': []},
            {name: 'бичиг хэрэг', 'count': '3', 'color':'pink', 'rank': 4.5},
            {name: 'спорт', 'count': '5', 'rank': 4.5, 'color': '#FDAE6B'},
            {name: 'авто', 'count': '5', 'rank': 4.5, 'color': '#FDAE6B'}
          ];

          this.tags = [
            {'_id': 1, 'color': 'red'},
            {'_id': 2, 'color': 'blue'},
            {'_id': 3, 'color': 'yellow'}
          ];

          this.items = [{"productID":"p00003","name":"Ном \"Мөнх Тэнгэрийн Монгол дор\"","price":"51750","quantityonhand":"9","categoryID":"books","image":"data/none.jpg"},{"productID":"p00004","name":"Ном \"УБ хөтөч\"","price":"30594.61","quantityonhand":"9","categoryID":"books","image":"data/none.jpg"},{"productID":"p00005","name":"ОЭШБХЭмхэтгэл 2012он","price":"9626.65","quantityonhand":"20","categoryID":"books","image":"data/none.jpg"},{"productID":"p00006","name":"ОЭШБХЭмхэтгэл 2013он","price":"18016.68","quantityonhand":"20","categoryID":"books","image":"data/none.jpg"},{"productID":"p00007","name":"ОЭШБХЭмхэтгэл 2014он","price":"29325","quantityonhand":"20","categoryID":"books","image":"data/none.jpg"},{"productID":"p00008","name":"Playing Love /морин хуурын CD/","price":"8280","quantityonhand":"50","categoryID":"CD_DVD","image":"data/none.jpg"},{"productID":"p00009","name":"Discover Mongolia /танилцуулга CD/","price":"14145","quantityonhand":"4","categoryID":"CD_DVD","image":"data/none.jpg"},{"productID":"p0001","name":"Ном \"Биеийн тамир спортын хууль\"","price":"3450","quantityonhand":"5","categoryID":"books","image":"data/none.jpg"},{"productID":"p00010","name":"Гончигсумлаа CD","price":"11500","quantityonhand":"1","categoryID":"CD_DVD","image":"data/none.jpg"},{"productID":"p00011","name":"Pentatonic CD","price":"5750","quantityonhand":"1","categoryID":"CD_DVD","image":"data/none.jpg"},{"productID":"p00012","name":"Хүүхдийн дууны DVD","price":"6670","quantityonhand":"10","categoryID":"CD_DVD","image":"data/none.jpg"},{"productID":"p00013","name":"Мемопад Вестерн юнион","price":"690","quantityonhand":"100","categoryID":"memopad","image":"data/none.jpg"},{"productID":"p00014","name":"Мемопад Е банк /олон өнгөтэй/","price":"1000","quantityonhand":"100","categoryID":"memopad","image":"data/none.jpg"},{"productID":"p00015","name":"Мемопад хатуу хавтастай","price":"2438","quantityonhand":"30","categoryID":"memopad","image":"data/none.jpg"},{"productID":"p00016","name":"Цаасан тор /жижиг/","price":"552","quantityonhand":"200","categoryID":"bag","image":"data/none.jpg"},{"productID":"p00017","name":"Цаасан тор /дунд/","price":"746.3","quantityonhand":"200","categoryID":"bag","image":"data/none.jpg"},{"productID":"p00018","name":"Цаасан тор /том/","price":"920","quantityonhand":"200","categoryID":"bag","image":"data/none.jpg"},{"productID":"p00019","name":"Шинэ жилийн бэлгийн цагаан цаасан тор","price":"1391.22","quantityonhand":"200","categoryID":"bag","image":"data/none.jpg"},{"productID":"p0002","name":"Ном \"Монголын эрсдэлтэй усан ая\"","price":"11500","quantityonhand":"6","categoryID":"books","image":"data/none.jpg"}];

          this.filter();
          this.find();
        },

        filter: function(e) {
          var findTags = {
            "Collection": "tags",
            "Sort": ["-rank"],
            "Skip": 0,
            "Limit": 70
          };
          this.$.xhrTags.body = JSON.stringify(findTags);
          this.$.xhrTags.generateRequest();
        },

        find: function(e) {
          var findProduct = {
            "Collection": "p",
            "Sort": ["rank"],
            "Skip": 0,
            "Limit": 30
          };
          this.$.xhrProduct.body = JSON.stringify(findProduct);
          this.$.xhrProduct.generateRequest();
        },

        handleItems: function(resp) {
          if (!resp.detail.response.Error) {
            this.items = resp.detail.response.Result.Data;
          }
        },

        handleTags: function(resp) {
          if (!resp.detail.response.Error) {
            this.tags = resp.detail.response.Result.Data;
          }
        },

        _toCart: function(e) {
          var id = e.model.index;
          var isRecorded = false;
          var newId = this.items[id]['productID'];
          app.carts.forEach(function(entry) {

            if (newId == entry['productID'])
            {
              isRecorded = true;
            }
          });

          if (isRecorded) {

            console.log('is inserted product.');

          } else {

            app.carts.push(this.items[id]);
            app.carts_count = app.carts.length;

            console.log('Someone put a product to cart has been successful.');

          };
        },

        itemUri: function(id) {
          return "/p/" + id;
        },

        
      });
    })();
  </script>

</dom-module>


<dom-module id="cart-catalog">
  <style>
    :host {
      display: block;
    }

    table, table td, table th {
      border-collapse: collapse;
      font-size: 13px;
      font-weight: normal;
    }

    table td, table th {
      border: 1px solid #ccc;
      padding: 10px 20px;
    }

    table th {
      text-transform: uppercase;
      color: #709700;
    }

  </style>

  <template>


    <div vertical layout style="margin: 15px 0 20px;">

       <!-- TODO: Эрэмбэлэх: үнээр, нийлүүлэгчээр -->
       <!-- TODO: Сагсанд бараа нэмэх -->
       <!-- TODO: Төлбөр хийх -->

      <!-- барааны жагсаалт-->
      <table class="table table-striped">
        <thead>
            <tr>
            <th>Зураг <span>{{ cartsCount }}</span></th>
            <th>Нэр</th>
            <th>Үнэ</th>
            <th>Тоо ширхэг</th>
            <th>Нийт</th>
            </tr>
        </thead>
        <tbody>
          <template is="dom-repeat" items="{{ cartItems }}" >
            <tr>
              <td><img src="{{item.image}}" style="height: 50px;"></td>
              <td>{{item.name}}</td>
              <td align="right">{{_toFixed( item.price, 2, 3)}}</td>
              <td>{{item.quantity}}</td>
              <td align="right">{{_toFixed(item.total, 2, 3)}}</td>
            </tr>
          </template>
        </tbody>
        <tfoot>
          <tr>
            <th colspan="4">Нийт</th>
            <th>
              {{_toFixed( cartsTotal, 2, 3)}}
            </th>
          </tr>
        </tfoot>
      </table>
      <g-pay
         merchant="100000000034033"
         invoice=""
         product=""
         price={{ cartsTotal }}
         currency="MNT"
         user="suldee"
         hash="{{ stamp }}"
         callback="#"
         size="medium"
         style="margin-top: 20px;">
      </g-pay>
    </div>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'cart-catalog',
        properties: {
          cartItems: {
            type: Array,
            notify: true,
          },
          letters: ['a', 'b', 'c'],
          cartsCount: {
            type: String,
          },
          cartsTotal: {
            type: String,
          },
          tags: {
              type: Array
          }
        },
        publish: {
          // won't reflect to an attribute
          bigText: '',
          // will reflect to an attribute
          active: {value: false, reflect: true}
        },
        _toFixed: function( value, n, x) {
          if (value) {
            var re = '\\d(?=(\\d{' + (x || 3) + '})+' + (n > 0 ? '\\.' : '$') + ')';
            return parseFloat(value).toFixed(Math.max(0, ~~n)).replace(new RegExp(re, 'g'), '$&,');
          }
        },
        ready: function() {
        // TODO: каталогит icon нэмэх. http://www.flaticon.com/packs/shopping
          this.menu = [
            {name: 'хувцас', 'count': '11', 'color':'#3182BD',  'rank': 4.5},
            {name: 'гоёл', 'count': '11', 'color':'#3182BD',  'rank': 4.5},
            {name: 'гэр ахуй', 'count': 12, 'color': '#E7560D'},
            {name: 'хүнс', 'count': 12, 'color': '#E7560D'},
            {name: 'компютер', 'color': '#FDAE6B', '_tags': []},
            {name: 'бичиг хэрэг', 'count': '3', 'color':'pink', 'rank': 4.5},
            {name: 'спорт', 'count': '5', 'rank': 4.5, 'color': '#FDAE6B'},
            {name: 'авто', 'count': '5', 'rank': 4.5, 'color': '#FDAE6B'}
          ];

          this.tags = [ ];

          this.cartItems = app.carts;

          /// this is total price for calculate
          this.cartsTotal = "0";
          for (var i=0; i<this.cartItems.length; i++) {
            this.cartItems[i]['quantity'] = 1;
            this.cartItems[i]['total'] = parseFloat(this.cartItems[i]['quantity']) * parseFloat(this.cartItems[i]['price']);

            this.cartsTotal = parseFloat(this.cartsTotal) + parseFloat(this.cartItems[i]['total']);
          }
          /// end total price


        },

        itemUri: function(id) {
          return "/p/" + id;
        },

        
      });
    })();
  </script>

</dom-module>